language: node_js
node_js:
  - "lts/*"

cache:
  directories:
    - "node_modules"

script:
  - npm run lint
  - npm run type-check
  - npm run test-with-coverage
  - npm run build

after_success:
  - npm run coverage

jobs:
  include:
    - stage: npm release
      if: tag IS present
      node_js: "lts/*"
      script:
        - npm run build
        - npm pack
      deploy:
        - provider: releases
          api_key: "${GITHUB_TOKEN}"
          file_glob: true
          file: "musically-api-*.tgz"
          skip_cleanup: true
          on:
            tags: true
        - provider: npm
          email: "${NPM_EMAIL}"
          api_key: "${NPM_TOKEN}"
          skip_cleanup: true
          on:
            tags: true
